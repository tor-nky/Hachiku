# Hachiku - Windows で薙刀式を使うスクリプト
2023年7月28日付[【薙刀式】v15fix版、発表](http://oookaworks.seesaa.net/article/500180437.html#gsc.tab=0)
から、__薙刀式v15fix版__ を Autohotkey に実装しました。  

---
パソコンの日本語キーボード、英語キーボードの設定に自動で合わせます。  
トレイアイコンを右クリックしたところに、縦書き・横書きモード切り替え、設定メニューがあります。  
レジストリの変更はしません。  

キーカスタマイズができる IME では「Shift+Ctrl+変換キー」に「全確定」、「Shift+Ctrl+無変換キー」に「全消去」を割り当てると動作を改善できます。
## 実行ファイル(薙刀式v15fix版)
https://github.com/tor-nky/Hachiku/releases
## ソースコードを直接実行する方法
ディレクトリ src の下にあるファイルをすべて保存します。  
Autohotkey をインストールし、ディレクトリ src にある Hachiku.ahk のスクリプトを実行してください。
# IME の設定
Hachiku のトレイアイコンを右クリックして設定を選び、IMEを選択します。
### 旧MS-IME
初期状態の設定のままで使えます。
しかし秀丸エディタを使ったり、全角英数入力を使ったりすることがあるのでしたら、次の設定をおすすめします。  
すると(全角英数入力時に)編集モードで選択範囲を意図せず消してしまうことがなくなります。

Microsoft IME の設定 → IME 入力モード切替の通知 → __オフ__: 画面中央に表示する

(キー設定をユーザー定義にしている場合)  
Microsoft IME の設定 → 詳細設定(A) → キー設定(Y)
|* キー|入力/変換済み文字なし|入力文字のみ|変換済み|候補一覧表示中|文節長変更中|変換済み文節内入力文字|
|---|:---:|:---:|:---:|:---:|:---:|:---:|
|半角/全角|IME-オン/オフ|__半英固定__|__半英固定__|__半英固定__|__半英固定__|__半英固定__|
|Ctrl+Shift+無変換| - |__全消去__|__全消去__|__全消去__|__全消去__|__全消去__|
|Ctrl+Shift+変換| - |__全確定__|__全確定__|__全確定__|__全確定__|__全確定__|

Ctrl+Shift+変換 は Ctrl+Enter を選択してキー追加すると簡単です。

そして Hachiku設定で「キー設定利用」をオンにしてください。
### 新MS-IME
IMEの設定に関係なく使えます。  
Hachiku設定「キー設定利用」は無視されます。
### ATOK
Hachiku のトレイアイコンを右クリックして設定を選び、ATOKを選択します。  
__必ず__ IMEの設定とキーカスタマイズをしてください。

ATOK プロパティ → 入力･変換 → 設定項目(Y) → 入力補助 → 特殊 → 設定一覧(L)
   - __なし__: 日本語入力オンで変更したモードを元に戻す

ATOK プロパティ → キー･ローマ字･色 → キーカスタマイズ(K)
|キー|機能|
|---|---|
|Shift+Esc|[_変換中_][_次候補表示中_]__変換取消__|
|変換|[_文字未入力_]__-----__|
|Shift+Ctrl+変換|[_入力中_][_変換中_][_次候補表示中_][_文節区切り直し中_]__全文確定__[_全候補表示中_]__全候補選択確定__[_記号入力_]__記号確定__|
|Shift+Ctrl+無変換|[_入力中_][_変換中_][_次候補表示中_][_文節区切り直し中_]__全文字削除__[_全候補表示中_]__全候補選択取消__|
|ひらがな|[_記号入力_以外]__入力文字種全角ひらがな(あ)__|
|カタカナ|[_記号入力_以外]__入力文字種全角カタカナ(ア)__|
|Shift+無変換|[_記号入力_以外]__入力文字種全角無変換(Ａ)__|
|半角／全角|[_文字未入力_][_記号入力_]日本語入力ON/OFF [_他_]__入力文字種半角無変換(A)__|

そして Hachiku設定で「キー設定利用」をオンにしてください。
### Google 日本語入力
Hachiku のトレイアイコンを右クリックして設定を選び、Googleを選択します。  

なお左右シフト英数に設定し、かな入力中に左右シフトで英字を入力すると __半角/全角キー__ が自動的に押されます。  
かな入力へは手動で戻して下さい。
Google 日本語入力 は一時的に英数入力になっていることが検出できないので、妥協の策です。

初期状態の設定のままでも使えますが、次の設定を行うと(全角英数入力時に)編集モードで選択範囲を意図せず消してしまうことがなくなります。

タスクトレイのアイコンを右クリック → プロパティ → キー設定 → キー設定の選択 → 編集
|モード|入力キー|コマンド|
|---|:---:|:---:|
|変換前入力中|Ctrl Shift Henkan|__確定__|
|変換中|〃|__〃__|
|変換前入力中|Ctrl Shift Muhenkan|__キャンセル__|
|変換中|〃|__〃__|
|変換前入力中|Shift Muhenkan|__全角英数に入力切替__|
|変換中|〃|__〃__|
|入力文字なし|〃|__〃__|
|変換前入力中|Hankaku/Zenkaku|__半角英数に入力切替__|
|変換中|〃|__〃__|

そして Hachiku設定で「キー設定利用」をオンにしてください。
# 独自機能
* 英数単打ではリピートができ、リピートにならないうちに続くキーを押せば SandS や編集モードの入力ができます。
* かな入力中でも方向キー、BS、Del を割り当てたキーにはリピートが働きます。
* Q+W に横書きモード、Q+A に縦書きモード を割り当て
* 編集モードD+F+H、J+K+Q、J+K+G、J+K+V、J+K+Bは、かな変換中かどうかを問いません。
* 固有名詞ショートカットに第二面（スペース押下）も設定できます。  
スペースキーを押したまま、そこから3つのキーを素早く押すと入力されます。
* 固有名詞ショートカットを最大５組切り替えられる。  
切り替えは E+R+1 で１番、E+R+2 で２番、など。  
「固有名詞登録」画面が出ているときに切り替えると、登録内容がコピーされます。
(OK を押すと登録されます)
* 「後置シフト」を設定可能
## そのほかの主な仕様
* かな入力中にアプリケーションのメニューをキーボードで操作できないことがある  
英数入力に切り替えてください
* Excel、PowerPoint のコメント欄にかな入力する際は、__一度かな入力ON を定義したキーで切り替えてください__。
* 編集モードや固有名詞の入力でIME 入力モード切替の通知が出る。  
全角記号を出力するために一旦、IMEをオフにしています。IMEの設定で通知をなくすことができます。
# 不具合
* Windowsがスリープするときに押していたキーが、スリープ解除後も押したままの扱いになる  
Hachiku を再起動すれば直ります。
* (秀丸エディタ)「名前を付けて保存」で IMEオフの状態だと、2文字目以降に大文字を入力してから何も入力ができない
* 入力したキーが無視されたり、押した順序が入れ替わったりする  
パソコンの性能によっては、予測入力(別名、ATOK:推測変換、Google日本語入力:サジェスト)を使うと起きることがあります。
* (新MS-IME) かな変換中に英数入力に切り替え、確定しないでキーを押すと最初の文字が入力されない。  
新MS-IME の仕様です。
* (新MS-IME) かな入力できなくなったり、入力中のかなが消せなくなることがある  
まず、他のウインドウをマウスで選び、再び元のソフトに切り替えてください。  
それでも直らないときは、ファイルに保存してソフトを一度終了してください。
* Windows 10 で、文字キーを押しながらWinキーかAltキーを長押ししてしまうとゲームバーが起動する  
回避するには、Windowsの「設定」→ゲーム→Xbox Game Bar
にある「コントローラーのこのボタンを使用してXbox Game Barを開く」を無効にします。  
こうするとレジストリに
`HKEY_CURRENT_USER\SOFTWARE\Microsoft\GameBar` 内に `UseNexusForGameBarEnabled`
というキーができています。  
これで先ほどの設定を有効にすると、間違ってゲームモードが起動したときに自動で強制無効になったりしますので、
こうなったらゲームコントローラでゲームバーを起動するには、自己責任でレジストリのキーを消去することになります。
# 動作確認
* Windows 10 Pro version 22H2 64-bit + AutoHotkey (v1.1.37.01) U64 Unicode 64-bit.bin  
新旧MS-IME、ATOK 2017、Google 日本語入力  
* Windows 11 Pro version 22H2 + AutoHotkey (v1.1.37.01) U64 Unicode 64-bit.bin  
新旧MS-IME、Google 日本語入力  
__AutoHotkey v2以降では使えません__

# 参考
* [【薙刀式】v15fix版、発表](http://oookaworks.seesaa.net/article/500180437.html#gsc.tab=0)
## src¥KanaTable¥*.ahk で使えるキーや記号の書き方
次の半角文字は書き換えが必要です。
```
0 → {0}
! → {!}
\# → {#}
^ → {^}
+ → {+}
` → ``
{ → {{}
} → {}}
" → ""
```
このほかの文字(全角文字も)はそのまま登録できます。

特殊キーは http://ahkwiki.net/Send のものが使えます。
```
{Enter} {Esc} {Space} {Tab} {BS} {Del} など
```
このほか、
```
{→} {->} {右} {←} {<-} {左} {↑} {上} {↓} {下}
{ペースト} {貼付} {貼り付け} {カット} {切取} {切り取り} {コピー}
{無変換} {変換} {ひらがな} {カタカナ} {改行} {後退} {取消} {削除}
{全角} {タブ} {空白} {メニュー} {Caps Lock} {Back Space}
{確定} {IMEOFF} {IMEON} {全英} {半ｶﾅ} {C_Clr} {C_Bkup} {C_Rstr}
```
なども使えます。

ASCIIコード以外の文字や {直接} から後の文字列は、一度 IME をオフにして出力したあと IME を元に戻します。
## 動作速度
* 最初の読み込み
1～2秒程度
* 英数、かなの普通の文字(スペースを除く)
通常 10 ms 以内、エクスプローラー 78 ms 以内。
(ローマ字の文字数によって変わる)
* 記号
Windows 11以降のメモ帳では最大 0.5秒。他は最大 0.4秒。
